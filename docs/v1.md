# Agent Workspace Collaboration Protocol (AWCP) v1 规范

## 1. 概述 (Overview)

### 1.1 协议简介

Agent Workspace Collaboration Protocol (AWCP) 是一个面向大模型多智能体协作的工作空间委派协议。它使一个本地智能体（**Delegator**，委派者）能够将指定的本地目录（Workspace）以"近似远端智能体本地目录"的方式委派给远端智能体（**Executor**，执行者）协作完成任务，并在任务结束后自动回收访问权限与资源。

AWCP 的核心设计思想是将**控制面**与**数据面**分离：控制面负责协商、握手与状态同步，采用基于 HTTP 的请求-响应模式与 SSE（Server-Sent Events）事件流；数据面负责工作空间的实际传输，支持多种传输适配器（Transport Adapter），包括基于 SSHFS 的挂载式传输和基于 ZIP 归档的 Archive 传输。通过**租约式（Lease-based）会话**、**导出视图目录（Export View）**、**执行者工作目录回传**与**准入门禁（Admission Control）**等机制，AWCP 实现了可控、可清理、可并发管理的多智能体远程协作。

### 1.2 设计目标

1.  **"像在自己电脑上工作"的体验**：Executor 可使用其自身工具链（文件读写、各种 CLI）对 Delegator 指定目录进行操作，无需修改工具实现。对于 SSHFS 传输，这通过透明的文件系统挂载实现；对于 Archive 传输，则通过完整的工作空间复制实现。
2.  **最小化 Delegator 的认知负担**：Delegator 仅需通过简单的 MCP 工具发起委派，无需关心传输细节。协议自动处理工作空间导出、凭证生成、结果回收等复杂流程。
3.  **传输方式可插拔**：通过 Transport Adapter 抽象，支持多种数据面实现。v1 提供 SSHFS（适合大型工作空间、低延迟场景）和 Archive（适合小型工作空间、无需 SSH 基础设施）两种传输方式。
4.  **安全可控**：
    *   **Executor 侧**：必须基于其本地策略选择工作目录（`workDir`），避免 Delegator 指定危险路径。
    *   **Delegator 侧**：不暴露真实路径，使用 Export View 进行隔离、审计与清理；通过准入门禁拒绝过大的工作空间。
5.  **资源可回收**：基于租约（Lease）的生命周期管理，确保任务结束或超时后资源被自动清理。


## 2. 系统架构与角色 (Architecture & Components)

### 2.1 核心术语与角色

| 角色/术语 | 说明 |
| :--- | :--- |
| **Delegator（委派者）** | 拥有本地数据，发起协作邀请，并负责环境目录构建的 Agent。在整个协作生命周期中扮演"客户端"角色，主动发起请求并订阅执行状态。 |
| **Executor（执行者）** | 接收协作邀请，将 Delegator 的资源映射到自己本地（Work Directory），并使用自有工具执行任务的 Agent。在协作中扮演"服务端"角色，提供 HTTP 端点供 Delegator 调用。 |
| **Transport Adapter（传输适配器）** | 数据面的可插拔实现。负责工作空间的实际传输，v1 提供 SSHFS 和 Archive 两种适配器。 |
| **Environment（环境）** | 一次委派的资源集合。通过 `EnvironmentSpec` 描述，可包含多个资源（v1 主要使用单个 `fs` 资源）。 |
| **ResourceSpec（资源规格）** | 环境中每个资源的描述，包含名称、类型、来源路径、访问模式等字段。 |
| **Environment Directory** | Delegator 为特定委派构建的隔离目录，包含资源的符号链接和元数据清单（`.awcp/manifest.json`）。 |
| **Work Directory** | Executor 本地的工作目录。对于 SSHFS 是挂载点，对于 Archive 是解压目录。由 Executor 根据本地策略决定，Delegator 不可指定。 |
| **Lease（租约）** | 一次协作会话的生命周期对象，包含 ID、TTL、访问模式等约束。 |

### 2.2 核心模型：租约式委派 (Delegation Lease)

AWCP 将一次协作视为一个 **Delegation Lease（委派租约）**，这是协议的核心抽象：

*   **唯一标识**：每个 Lease 拥有唯一的 `delegationId`（UUID 格式）。
*   **绑定关系**：租约绑定了目标 Executor URL、本地工作空间路径、租约时长（TTL）与访问模式（只读或读写）。
*   **双向确认**：协作的建立需要双方确认：
    *   Delegator 发起意图（INVITE），声明任务需求与约束。
    *   Executor 确认并回传工作目录（ACCEPT），声明自身约束。
    *   Delegator 正式授权（START），下发传输凭证。
*   **生命周期**：由状态机管理，确保在任务完成、出错或 TTL 到期时执行清理。

### 2.3 组件架构

AWCP 的实现分为三个层次：

*   **核心层（@awcp/core）**：定义协议类型、消息格式、状态机与错误体系。这一层是纯粹的类型定义与逻辑，不包含任何 I/O 操作。

*   **SDK 层（@awcp/sdk）**：实现 Delegator Service 和 Executor Service，封装完整的协议流程。SDK 通过依赖注入接收 Transport Adapter，实现数据面的可插拔。

*   **传输层（@awcp/transport-*）**：实现具体的传输适配器。v1 提供两种：
    *   **SSHFS Transport**：基于 SSH 证书认证的文件系统挂载，适合大型工作空间与低延迟场景。
    *   **Archive Transport**：基于 HTTP 的 ZIP 归档传输，适合小型工作空间与简单部署场景。

*   **工具层（@awcp/mcp）**：为 LLM Agent 提供 MCP（Model Context Protocol）工具接口，包括 `delegate`、`delegate_output`、`delegate_cancel` 等工具。

> **参考**：详细的架构图请参阅 [Architecture Diagrams](architecture.md)，包含系统概览、包依赖关系、消息流程、状态机等可视化图表。


## 3. 协议交互流程 (Protocol Workflow)

AWCP 定义了标准的四阶段握手流程：**INVITE → ACCEPT → START → 任务执行 → 结果返回**。与传统的请求-响应模式不同，AWCP 的任务执行是异步的——START 消息发送后，Delegator 通过 SSE（Server-Sent Events）事件流订阅任务状态，直到收到完成或错误事件。

### 3.1 准入门禁（Admission Control）

在进入握手之前，Delegator 应先执行**准入门禁**：对即将导出的 Workspace 做快速预检。这一步骤的目的是在协议握手开始前就拒绝明显不适合协作的工作空间，避免浪费网络带宽和计算资源。

准入门禁的默认检查项包括：
*   **总大小限制**：工作空间总字节数不超过阈值（默认 100MB）
*   **文件数量限制**：文件总数不超过阈值（默认 10,000 个）
*   **单文件大小限制**：最大单文件不超过阈值（默认 50MB）
*   **自动排除**：`node_modules/` 和 `.git/` 目录不计入统计

若预检失败，Delegator 应直接返回错误（`code: WORKSPACE_TOO_LARGE`），并在 `hint` 中建议调用方缩小 Scope 后再发起协作。

### 3.2 流程时序图

```
Delegator                                  Executor
    │                                          │
    │  1. INVITE (Task, Environment, Lease)    │
    │  ─────────────────────────────────────►  │
    │                                          │  2. Policy Check & Env Check
    │  3. ACCEPT (WorkDir, Constraints)        │     (检查策略、分配工作目录)
    │  ◄─────────────────────────────────────  │
    │                                          │
    │  4. Prepare Transport                    │
    │     • SSHFS: 生成证书                    │
    │     • Archive: 打包 ZIP + Base64 编码    │
    │     • Storage: 上传到存储服务，生成 URL  │
    │                                          │
    │  5. START (Lease, WorkDirInfo)           │
    │  ─────────────────────────────────────►  │
    │                                          │  6. Setup Workspace
    │  7. Response: { ok: true }               │     • SSHFS: 挂载远程目录
    │  ◄─────────────────────────────────────  │     • Archive: 解压 Base64 数据
    │                                          │     • Storage: 通过 URL 下载并解压
    │  8. GET /tasks/:id/events (SSE)          │
    │  ─────────────────────────────────────►  │  9. Execute Task
    │                                          │     (在工作目录中执行任务)
    │  ◄─── SSE: { type: "status" } ─────────  │
    │  ◄─── SSE: { type: "done", result } ───  │  10. Teardown & Return Result
    │                                          │      • SSHFS: 卸载（修改已同步）
    │  11. Apply Result & Cleanup              │      • Archive: 打包 resultBase64
    │      • Archive/Storage: 解压覆盖原目录   │      • Storage: 上传到 uploadUrl
    │      • SSHFS: 无需操作（实时同步）       │
```

### 3.3 关键安全原则

1.  **Executor 拥有工作目录最终决定权**：Delegator 不能指定 Executor 的工作目录。Executor 必须在 `ACCEPT` 中回传符合其本地安全策略的 `executorWorkDir`，通常位于专用的工作目录根下（如 `/awcp/workspaces/{delegationId}`）。

2.  **凭证后置下发**：Delegator 不在 `INVITE` 阶段发送有效凭证。只有收到 Executor 的 `ACCEPT` 确认后，才在 `START` 阶段下发传输所需的凭证（SSHFS 的 SSH 证书，或 Archive 的工作空间数据）。

3.  **本地沙箱约束**：Executor 在协作时可声明其 `sandboxProfile`（如是否限制在工作目录内、是否允许联网、是否允许执行命令），让 Delegator 提前知晓环境限制以避免任务失败。

### 3.4 SSE 事件流

START 消息发送后，Delegator 通过 HTTP SSE 订阅任务执行状态。这是 AWCP 实现异步任务执行的核心机制。

**端点**：`GET /awcp/tasks/{delegationId}/events`

**响应**：`Content-Type: text/event-stream`，每个事件以 `data: {JSON}\n\n` 格式发送。

**事件类型**：

| 类型 | 触发时机 | 关键字段 |
| :--- | :--- | :--- |
| `status` | 任务开始执行、进度更新 | `status`（`running` / `progress`）、`message`、`progress` |
| `done` | 任务成功完成 | `summary`、`highlights`、`resultBase64` |
| `error` | 任务执行失败 | `code`、`message`、`hint` |

其中，`resultBase64` 字段仅在 Archive/Storage 传输时使用，包含修改后工作空间的 Base64 编码 ZIP 归档。


## 4. 消息定义 (Message Definitions)

AWCP 定义了 5 种消息类型，根据场景使用不同的传输机制：

| 消息类型 | 传输机制 | 方向 | 说明 |
| :--- | :--- | :--- | :--- |
| `INVITE` | HTTP POST `/awcp` | Delegator → Executor | 发起协作请求 |
| `ACCEPT` | HTTP 响应 | Executor → Delegator | 接受请求 |
| `START` | HTTP POST `/awcp` | Delegator → Executor | 授权并启动任务 |
| `DONE` | SSE 事件流 | Executor → Delegator | 任务完成通知 |
| `ERROR` | HTTP 响应 / SSE | 双向 | 错误或拒绝 |

**同步消息**（INVITE、ACCEPT、START、ERROR）通过 HTTP POST 发送至 Executor 的 `/awcp` 端点，适用于协商与启动阶段。

**异步消息**（DONE、ERROR、状态更新）通过 SSE `/awcp/tasks/:id/events` 推送，适用于任务执行阶段。任务执行时间不确定，采用事件流可以实时推送中间状态与最终结果。

消息采用 JSON 格式，所有字段名使用 camelCase 命名规范。每条消息都包含协议版本号、消息类型和委派 ID。

### 4.1 基础消息结构

所有 AWCP 消息共享以下基础字段：

| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `version` | `"1"` | 协议版本号，v1 固定为 `"1"` |
| `type` | `string` | 消息类型：`INVITE`、`ACCEPT`、`START`、`DONE`、`ERROR` |
| `delegationId` | `string` | 委派唯一标识（UUID 格式） |

### 4.2 INVITE (Delegator → Executor)

**语义**：Delegator 发起协作请求。包含任务描述、环境资源声明与约束建议，**不含传输凭证**。用于 Executor 进行预检并决定是否接受。

**必填字段**：

| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `task.description` | `string` | 短描述，用于日志与任务列表 |
| `task.prompt` | `string` | 完整任务说明，含目标与禁忌 |
| `lease.ttlSeconds` | `number` | Delegator 提议的租约时长（秒） |
| `lease.accessMode` | `"ro"` \| `"rw"` | 访问模式：只读或读写 |
| `environment.resources` | `ResourceSpec[]` | 环境资源声明 |

**可选字段**：

| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `requirements.transport` | `string` | 期望的传输方式：`sshfs`、`archive`、`storage` |
| `auth.type` | `string` | 认证类型：`api_key`、`bearer`、`oauth2`、`custom` |
| `auth.credential` | `string` | 认证凭证 |
| `auth.metadata` | `object` | 附加认证元数据 |

**ResourceSpec 结构**：

| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `name` | `string` | 资源名称（如 `"workspace"`） |
| `type` | `"fs"` | 资源类型，v1 仅支持文件系统 |
| `source` | `string` | Delegator 本地路径 |
| `mode` | `"ro"` \| `"rw"` | 访问模式 |
| `include` | `string[]` | 包含的文件模式（保留字段，v1 未实现） |
| `exclude` | `string[]` | 排除的文件模式（保留字段，v1 未实现） |

> **说明**：`environment.resources` 支持声明多个资源，但 v1 参考实现通常只使用一个名为 `"workspace"` 的 `fs` 资源。

### 4.3 ACCEPT (Executor → Delegator)

**语义**：Executor 接受请求。回传**工作目录**与**自我约束声明**。工作目录由 Executor 根据本地策略决定，Delegator 不可指定。

**必填字段**：

| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `executorWorkDir.path` | `string` | Executor 本地绝对路径，由 Executor 策略决定 |

**可选字段**（ExecutorConstraints）：

| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `acceptedAccessMode` | `"ro"` \| `"rw"` | 实际接受的权限（可降级） |
| `maxTtlSeconds` | `number` | Executor 允许的最大时长 |
| `sandboxProfile.cwdOnly` | `boolean` | 工具是否限制在工作目录内 |
| `sandboxProfile.allowNetwork` | `boolean` | 是否允许联网 |
| `sandboxProfile.allowExec` | `boolean` | 是否允许执行命令 |

### 4.4 START (Delegator → Executor)

**语义**：Delegator 确认并授权。下发**租约信息**与**传输凭证**。Executor 收到后设置工作空间并开始任务执行。

START 消息发送后，Executor 应同步返回 `{ ok: true }` 表示已开始处理，任务执行结果通过 SSE 事件流异步返回。

**必填字段**：

| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `lease.expiresAt` | `string` | 租约过期绝对时间（ISO 8601 格式） |
| `lease.accessMode` | `"ro"` \| `"rw"` | 最终生效权限 |
| `workDir` | `WorkDirInfo` | 传输相关信息，结构取决于传输类型 |

**WorkDirInfo** 是一个联合类型，根据传输方式有三种形式：

**SSHFS 传输** (`transport: "sshfs"`)：

| 字段 | 说明 |
| :--- | :--- |
| `endpoint.host` | SSH 服务器地址 |
| `endpoint.port` | SSH 端口（通常为 22） |
| `endpoint.user` | SSH 用户名 |
| `exportLocator` | 导出目录路径 |
| `credential.privateKey` | 临时 SSH 私钥（ED25519） |
| `credential.certificate` | CA 签名的 SSH 证书（含 TTL） |
| `options` | 可选挂载参数 |

**Archive 传输** (`transport: "archive"`)：

| 字段 | 说明 |
| :--- | :--- |
| `workspaceBase64` | 工作空间的 Base64 编码 ZIP 归档 |
| `checksum` | SHA-256 校验和，用于完整性验证 |

**Storage 传输** (`transport: "storage"`)：

| 字段 | 说明 |
| :--- | :--- |
| `downloadUrl` | Executor 下载工作空间的预签名 URL |
| `uploadUrl` | Executor 上传结果的预签名 URL |
| `checksum` | SHA-256 校验和 |
| `expiresAt` | URL 过期时间（ISO 8601 格式） |
| `headers` | 可选认证头 |

### 4.5 DONE (SSE 事件)

**语义**：Executor 完成任务，提交总结与成果。

DONE 是异步消息，通过 SSE 事件流返回（而非 HTTP 响应），因为任务执行时间不确定。

| 字段 | 类型 | 必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `type` | `"done"` | ✓ | 事件类型（SSE 中为小写） |
| `timestamp` | `string` | ✓ | ISO 8601 时间戳 |
| `summary` | `string` | ✓ | 核心产出文本，说明做了什么、结果如何 |
| `highlights` | `string[]` | | 建议 Delegator 查看的文件列表 |
| `resultBase64` | `string` | | Archive/Storage 传输专用：修改后工作空间的 Base64 ZIP |

### 4.6 ERROR (任意方向)

**语义**：报告失败、拒绝或异常中止。可以作为 HTTP 响应直接返回（如拒绝 INVITE），也可以通过 SSE 事件流返回（如任务执行失败）。

| 字段 | 类型 | 必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `code` | `string` | ✓ | 错误码（见下表） |
| `message` | `string` | ✓ | 人类可读描述 |
| `hint` | `string` | | 修复建议 |

**错误码集 (v1)**：

| Code | 含义 | 典型场景 |
| :--- | :--- | :--- |
| `DECLINED` | Executor 拒绝协作 | 达到并发上限、不支持的传输方式 |
| `DEP_MISSING` | 缺少依赖 | Executor 未安装 sshfs |
| `WORKSPACE_TOO_LARGE` | 工作空间体量超限 | 准入门禁拒绝 |
| `WORKSPACE_NOT_FOUND` | 工作空间目录不存在 | 路径错误 |
| `WORKSPACE_INVALID` | 工作空间无效 | 路径不是目录 |
| `WORKDIR_DENIED` | 工作目录被策略拒绝 | 违反 Executor 本地策略 |
| `START_EXPIRED` | START 前租约已失效 | ACCEPT 后等待过久 |
| `EXPIRED` | 运行中租约到期 | 任务执行超时 |
| `AUTH_FAILED` | 认证失败 | 凭证无效或过期 |
| `SETUP_FAILED` | 工作空间设置失败 | SSHFS 挂载失败、Archive 解压失败 |
| `TASK_FAILED` | 任务执行出错 | Agent 执行过程中出错 |
| `CANCELLED` | 用户或系统取消 | 主动取消委派 |
| `TRANSPORT_ERROR` | 传输层错误 | 网络故障、传输失败 |
| `CHECKSUM_MISMATCH` | 校验和不匹配 | 数据传输损坏 |

## 5. 数据面规范 (Data Plane Specification)

数据面负责将 Delegator 的 Environment Directory 映射到 Executor 的 Work Directory。AWCP v1 通过 **Transport Adapter** 抽象支持多种传输方式，目前提供三种实现：**SSHFS**（挂载式）、**Archive**（归档式）和 **Storage**（存储服务式）。三种传输方式各有优劣，适用于不同场景。

### 5.1 Transport Adapter 接口

Transport Adapter 是数据面的可插拔实现，分为 **Delegator 侧**和 **Executor 侧**两组职责：

**Delegator 侧职责**：

| 方法 | 说明 |
| :--- | :--- |
| `prepare(delegationId, exportPath, ttlSeconds)` | 准备传输，返回 `WorkDirInfo` |
| `cleanup(delegationId)` | 清理传输资源 |
| `applyResult(delegationId, resultData, resources)` | 可选：将 Executor 修改应用回原目录 |

**Executor 侧职责**：

| 方法 | 说明 |
| :--- | :--- |
| `checkDependency()` | 检查依赖是否满足（如 sshfs 是否安装） |
| `setup(delegationId, workDirInfo, workDir)` | 设置工作空间，返回实际工作路径 |
| `teardown(delegationId, workDir)` | 清理并返回结果（可选 `resultBase64`） |

### 5.2 SSHFS 传输

SSHFS 传输基于 SSH 文件系统挂载，使 Executor 能够像访问本地文件一样访问 Delegator 的工作空间。修改是实时同步的，无需在任务完成后回传结果。

**工作原理**：

1. **Delegator 准备阶段**：
   - 生成 ED25519 密钥对
   - 使用 CA 私钥签发 SSH 证书（证书内置 TTL，自动过期）
   - 返回 SSH 端点信息和凭证

2. **Executor 设置阶段**：
   - 将凭证写入临时文件
   - 使用 `sshfs` 命令挂载远程目录
   - 验证挂载成功（通过比较设备 ID）

3. **任务执行阶段**：
   - Executor 在挂载目录中执行任务
   - 文件修改实时同步到 Delegator

4. **清理阶段**：
   - Executor 卸载文件系统（`umount` / `fusermount -u`）
   - Delegator 删除临时密钥文件

**优点**：
- 实时同步，无需回传结果
- 支持大型工作空间
- 低延迟文件访问

**缺点**：
- 需要 SSH 基础设施（服务端配置 `TrustedUserCAKeys`）
- Executor 需要安装 `sshfs` 和 FUSE
- 受网络延迟影响，对大量小文件操作性能较差

**依赖与环境**：
- Delegator：OpenSSH 服务端，支持证书认证
- Executor：`sshfs` 客户端及 FUSE 驱动
- 网络：Executor 必须能访问 Delegator 的 SSH 端口

**主要配置项**：CA 私钥路径（`caKeyPath`）、临时密钥目录（`keyDir`）、SSH 连接参数（`host`、`port`、`user`）。

### 5.3 Archive 传输

Archive 传输通过 HTTP 传输 ZIP 归档，无需 SSH 基础设施。工作空间在 START 消息中以 Base64 编码发送，任务完成后修改后的工作空间以同样方式返回。

**工作原理**：

1. **Delegator 准备阶段**：
   - 将导出目录打包为 ZIP 归档（压缩级别 6）
   - 计算 SHA-256 校验和
   - 将归档转换为 Base64 字符串

2. **Executor 设置阶段**：
   - 解码 Base64 数据
   - 验证校验和（防止传输损坏）
   - 解压到工作目录（包含路径遍历保护）

3. **任务执行阶段**：
   - Executor 在本地工作目录中执行任务
   - 修改只存在于 Executor 本地

4. **清理阶段**：
   - 将工作目录重新打包为 ZIP 归档
   - 转换为 Base64 并通过 `TaskDoneEvent.resultBase64` 返回
   - Delegator 解压覆盖原工作空间

**优点**：
- 零依赖，无需 SSH 基础设施
- 部署简单，适合云环境
- 传输可靠，有校验和验证

**缺点**：
- 需要完整传输工作空间（两次）
- 内存占用较高（Base64 编码增加约 33% 大小）
- 不适合大型工作空间（建议 < 50MB）

**主要配置项**：临时归档目录（`tempDir`）。

### 5.4 Storage 传输

Storage 传输通过外部存储服务（如 S3、MinIO）传输工作空间。与 Archive 传输类似使用 ZIP 归档，但数据通过预签名 URL 传输而非嵌入消息。适合中间商/平台场景和大型工作空间。

**工作原理**：

1. **Delegator 准备阶段**：
   - 将导出目录打包为 ZIP 归档
   - 上传到存储服务
   - 生成预签名下载 URL 和上传 URL
   - 返回 URL 信息

2. **Executor 设置阶段**：
   - 通过 downloadUrl 下载归档
   - 验证 SHA-256 校验和
   - 解压到工作目录

3. **任务执行阶段**：
   - Executor 在本地工作目录中执行任务

4. **清理阶段**：
   - 将工作目录重新打包为 ZIP 归档
   - 通过 uploadUrl 上传到存储服务
   - 或通过 `resultBase64` 返回（小文件）

**优点**：
- 支持大型工作空间（无消息大小限制）
- 支持 Delegator 离线（结果存储在外部服务）
- 适合中间商/平台场景
- 消息体轻量（仅 URL）

**缺点**：
- 需要外部存储服务
- 需要处理 URL 过期问题
- 两次传输延迟

**Delegator 侧配置项**：

| 配置项 | 说明 |
| :--- | :--- |
| `provider.type` | 存储提供者类型：`local`（本地 HTTP 服务）或 `s3`（S3 兼容存储） |
| `provider.localDir` | Local 提供者：本地存储目录 |
| `provider.bucket` | S3 提供者：存储桶名称 |
| `provider.region` | S3 提供者：区域 |
| `provider.endpoint` | S3 提供者：端点 URL（MinIO 等兼容服务需要） |
| `provider.accessKeyId` | S3 提供者：访问密钥 ID |
| `provider.secretAccessKey` | S3 提供者：访问密钥 |
| `tempDir` | 临时归档目录 |
| `urlTtlSeconds` | 预签名 URL 有效期（秒） |

**Executor 侧配置项**：`tempDir`（临时归档目录）。

### 5.5 传输方式对比

| 特性 | SSHFS | Archive | Storage |
| :--- | :--- | :--- | :--- |
| **数据传输** | 实时挂载（按需读取） | 完整复制（消息内嵌） | 完整复制（URL 引用） |
| **结果返回** | 自动同步，无需返回 | 通过 `resultBase64` 返回 | 通过 URL 或 `resultBase64` |
| **适用大小** | 大型工作空间 | 小型工作空间 (< 50MB) | 任意大小 |
| **依赖** | SSH 服务端 + sshfs 客户端 | 无 | 外部存储服务 |
| **网络要求** | 持续连接，低延迟优先 | 单次传输，带宽优先 | HTTP 访问存储服务 |
| **使用场景** | 本地网络、开发环境 | 云环境、简单部署 | 中间商/平台场景 |

### 5.6 实现注意事项

1.  **网络可达性**：SSHFS 要求 Executor 能直接访问 Delegator 的 SSH 端口。NAT、防火墙等可能导致连接失败。Archive 传输通过 HTTP 进行，通常更容易穿越网络边界。

2.  **符号链接风险**：工作空间内的符号链接可能指向范围外的文件。建议在导出层过滤或限制符号链接，防止信息泄露。

3.  **路径遍历保护**：Archive 解压时必须验证每个条目的路径，防止恶意归档通过 `../` 等路径逃逸到工作目录外。

4.  **资源清理**：无论任务成功与否，都应确保清理临时文件（密钥、归档）和释放资源（卸载挂载点）。

## 6. Delegator 侧实现规范 (Delegator Implementation)

### 6.1 环境目录 (Environment Directory)

Delegator 为每个 Delegation 构建隔离的 **Environment Directory**（环境目录），其中包含资源的符号链接和元数据清单。这一设计有三个目的：便于权限管理、支持多资源环境、以及支持清理与审计。

**目录结构**：
```
{baseDir}/{delegationId}/
├── workspace/              # 资源符号链接（指向原始目录）
└── .awcp/
    └── manifest.json       # 环境元数据清单
```

**元数据清单示例**：
```json
{
  "version": "1",
  "delegationId": "dlg_a1b2c3d4",
  "createdAt": "2026-02-01T12:00:00.000Z",
  "resources": [
    { "name": "workspace", "type": "fs", "source": "/path/to/project", "mode": "rw" }
  ]
}
```

**资源物化策略**：v1 参考实现使用符号链接（symlink）将资源物化到环境目录。未来可扩展支持 Bind Mount 或 Git Worktree 等策略以增强隔离性。

### 6.2 准入门禁详解 (Admission Control)

准入门禁在发送 INVITE 前执行，目的是尽早拒绝不适合协作的工作空间，避免浪费资源。

**默认配置**：总大小限制 100MB、文件数量限制 10,000 个、单文件大小限制 50MB。

**自动排除目录**：扫描时自动跳过 `node_modules/` 和 `.git/`，这些目录通常体积大但对任务执行不是必需的。

**失败处理**：若预检失败，应返回 `WORKSPACE_TOO_LARGE` 错误，并在 `hint` 中提供可操作的建议（如"Consider selecting a smaller subdirectory"）。

> **实现提示**：体量预检不要求精确。只要能在可控时间内给出"明显不适合协作"的判断，就足以保护系统与网络。

### 6.3 DelegatorService API

SDK 提供 `DelegatorService` 类封装完整的 Delegator 逻辑。主要方法：

| 方法 | 说明 |
| :--- | :--- |
| `delegate(params)` | 发起委派，返回 `delegationId` |
| `getDelegation(id)` | 获取委派状态 |
| `waitForCompletion(id, timeout?)` | 阻塞等待委派完成 |
| `cancel(id)` | 取消委派 |

**配置项**：环境目录根路径（`environment.baseDir`）、传输适配器（`transport`）、准入控制（`admission`）、默认值（`defaults.ttlSeconds`、`defaults.accessMode`）。

### 6.4 结果应用（Archive/Storage 传输）

当使用 Archive 或 Storage 传输时，任务完成后 Delegator 会收到 `resultBase64` 字段，包含修改后工作空间的 ZIP 归档。SDK 会自动将其应用回原始资源目录：

1. 解码 Base64 数据为 ZIP 文件
2. 解压到临时目录
3. 对每个 `mode: "rw"` 的资源，将修改后的内容复制回 `resource.source` 目录
4. 删除临时文件

**覆盖行为**：已修改的文件会被覆盖，未修改的文件保持不变，新增的文件会被添加。注意：Executor 删除的文件**不会**从原目录中删除（归档只包含当前存在的文件）。

### 6.5 并发控制策略

当多个 Delegation 试图访问同一物理目录时，为防止数据覆盖与冲突，Delegator 应实施并发策略：

1.  **任务级互斥（默认推荐）**：同一时间只允许一个 `rw` 任务访问同一物理目录。后续任务需排队等待。

2.  **Scope 隔离（高并发推荐）**：将大任务拆解为互不重叠的子目录 Scope，为每个 Delegation 导出不同的子目录，实现真正的并行协作。

> **注意**：v1 强烈不建议"乐观并发"（允许多人同时访问同一目录且无锁），这在文件系统层面极易导致更新丢失。

## 7. Executor 侧实现规范 (Executor Implementation)

### 7.1 本地安全策略 (Local Policy)

Executor 必须实施严格的本地策略，以**保护本机文件系统不被覆盖或污染**：

**工作目录根限制**：Executor 应配置一个专用的根目录（如 `/awcp/workspaces/`），所有委派的工作目录必须位于该目录下。典型的工作目录路径为 `{workDirRoot}/{delegationId}`。严禁接受系统敏感路径（如 `/home`、`/etc`、`~`）。

**非空检查**：在设置工作空间前，必须检查目标目录是否为空。若目录非空（可能有残留文件或重要数据），必须拒绝以防止数据遮挡或丢失。

**并发限制**：Executor 应限制同时运行的委派数量（默认最大 5 个），避免资源耗尽。超过限制时返回 `DECLINED` 错误。

### 7.2 沙箱与执行约束 (Sandbox Profile)

Executor 在 `ACCEPT` 消息中回传 `sandboxProfile`，这是一种**能力声明**机制，让 Delegator 提前知晓执行环境的限制：

| 声明 | 含义 | Delegator 可据此判断 |
| :--- | :--- | :--- |
| `cwdOnly: true` | 工具操作限制在工作目录内 | 任务不会影响 Executor 其他文件 |
| `allowNetwork: false` | 不允许联网 | 不应派发需要下载依赖的任务 |
| `allowExec: false` | 不允许执行命令 | 只能进行文件修改，不能运行测试 |

这些声明是 Executor 对自身的约束，Delegator 应根据这些声明调整任务内容或选择更合适的 Executor。

### 7.3 ExecutorService API

SDK 提供 `ExecutorService` 类封装完整的 Executor 逻辑。该服务接收一个 `TaskExecutor` 实例，与具体的 Agent 框架解耦。

| 方法 | 说明 |
| :--- | :--- |
| `handleMessage(message)` | 处理 AWCP 消息（INVITE、START、ERROR） |
| `subscribeTask(id, callback)` | 订阅任务事件（用于 SSE） |
| `cancelDelegation(id)` | 取消委派 |

**配置项**：工作目录根（`workDir`）、传输适配器（`transport`）、沙箱配置（`sandbox`）、策略约束（`policy`，包括 `maxConcurrentDelegations`、`maxTtlSeconds`、`allowedAccessModes`、`autoAccept`）。

> **说明**：v1 参考实现提供 `A2ATaskExecutor` 适配器，可将 A2A SDK 的 `AgentExecutor` 包装为 `TaskExecutor`，实现与 A2A 协议的兼容。

### 7.4 HTTP 端点

Executor 需要暴露以下 HTTP 端点供 Delegator 调用：

| Method | Path | 说明 |
| :--- | :--- | :--- |
| `POST` | `/awcp` | 接收 AWCP 消息（INVITE、START、ERROR） |
| `GET` | `/awcp/tasks/{id}/events` | SSE 事件流订阅 |
| `POST` | `/awcp/cancel/{id}` | 取消指定委派 |
| `GET` | `/awcp/status` | 获取服务状态 |

**消息处理逻辑**：
- **INVITE**：检查策略、依赖，分配工作目录，返回 ACCEPT 或 ERROR
- **START**：设置传输（挂载/解压），启动异步任务执行，返回 `{ ok: true }`
- **ERROR**：清理相关资源

### 7.5 任务执行流程

收到 START 消息后，Executor 异步执行以下流程：

1. **工作空间准备**：创建工作目录（确保为空）
2. **传输设置**：调用 `transport.setup()` 设置工作空间
   - SSHFS：挂载远程目录
   - Archive：解压 Base64 数据
   - Storage：通过 URL 下载并解压
3. **发送状态事件**：通过 SSE 发送 `{ type: "status", status: "running" }`
4. **执行任务**：调用 TaskExecutor 执行任务
5. **传输清理**：调用 `transport.teardown()` 清理并打包结果
   - SSHFS：卸载挂载点
   - Archive：打包工作目录为 `resultBase64`
   - Storage：打包并上传到 `uploadUrl`
6. **发送结果事件**：通过 SSE 发送 `{ type: "done", summary, resultBase64? }` 或 `{ type: "error", ... }`
7. **释放资源**：删除工作目录

## 8. 集成与运行模型 (Integration & Runtime Model)

本章描述 AWCP 如何集成到 Agent 运行环境中，包括生命周期状态机、MCP 工具接口以及服务发现机制。

### 8.1 生命周期状态机 (Lifecycle State Machine)

每个 Delegation 由状态机管理其生命周期，确保资源正确分配与回收。状态机定义了 9 种状态和明确的状态转换规则。

**状态定义**：

| 状态 | 类型 | 说明 |
| :--- | :--- | :--- |
| `created` | 非终态 | 委派已创建，尚未发送 INVITE |
| `invited` | 非终态 | INVITE 已发送，等待 ACCEPT |
| `accepted` | 非终态 | ACCEPT 已收到，准备发送 START |
| `started` | 非终态 | START 已发送，等待任务开始执行 |
| `running` | 非终态 | 任务正在执行中 |
| `completed` | 终态 | 任务成功完成 |
| `error` | 终态 | 发生错误 |
| `cancelled` | 终态 | 被用户或系统取消 |
| `expired` | 终态 | 租约过期 |

**状态转换图**：

```
                              ┌─────────────────────────────────────────┐
                              │                                         ▼
created ──► invited ──► accepted ──► started ──► running ──► completed
    │           │           │           │           │
    │           │           │           │           └──────► expired
    │           │           │           │                       ▲
    │           │           │           └──────────────────────►│
    │           │           └──────────────────────────────────►│
    │           └──────────────────────────────────────────────►│
    │                                                           │
    └───────────────────────────────────────► error ◄───────────┘
                                                ▲
                                                │
                              cancelled ◄───────┴───────────────────
```

**状态转换规则**：

| 起始状态 | 可转换到 |
| :--- | :--- |
| `created` | `invited`, `error`, `cancelled` |
| `invited` | `accepted`, `error`, `cancelled`, `expired` |
| `accepted` | `started`, `error`, `cancelled`, `expired` |
| `started` | `running`, `error`, `cancelled` |
| `running` | `completed`, `error`, `cancelled`, `expired` |
| 终态 | 无（不可转换） |

> **设计说明**：`started` 状态不能转换到 `expired`，因为正在设置工作空间，应等待设置完成或失败。

**转换事件**：

| 事件 | 有效起始状态 | 目标状态 |
| :--- | :--- | :--- |
| `SEND_INVITE` | `created` | `invited` |
| `RECEIVE_ACCEPT` | `invited` | `accepted` |
| `SEND_START` | `accepted` | `started` |
| `SETUP_COMPLETE` | `started` | `running` |
| `RECEIVE_DONE` | `running` | `completed` |
| `RECEIVE_ERROR` / `SEND_ERROR` | 任意非终态 | `error` |
| `CANCEL` | 任意非终态 | `cancelled` |
| `EXPIRE` | `invited`, `accepted`, `running` | `expired` |

### 8.2 MCP 工具接口 (MCP Tooling Interface)

AWCP 提供 MCP（Model Context Protocol）工具层，使 LLM Agent 能够通过简单的工具调用发起和管理委派。

#### 8.2.1 `delegate` 工具

发起工作空间委派，是最核心的工具。

**主要参数**：

| 参数 | 必填 | 说明 |
| :--- | :--- | :--- |
| `description` | ✓ | 短任务描述（用于日志） |
| `prompt` | ✓ | 完整任务说明 |
| `workspace_dir` | ✓ | 本地工作空间路径 |
| `peer_url` | ✓ | Executor 的 AWCP 端点 URL |
| `cwd` | | 用于解析相对路径的工作目录，默认 `process.cwd()` |
| `ttl_seconds` | | 租约时长（秒），默认 3600 |
| `access_mode` | | 访问模式，默认 `"rw"` |
| `background` | | 是否后台执行，默认 `false` |

**行为模式**：

- **同步模式**（`background: false`）：工具挂起直到任务完成或出错，最长等待 1 小时。适用于需要立即获取结果的短任务。

- **异步模式**（`background: true`）：立即返回 `delegationId`，任务在后台执行。需要通过 `delegate_output` 获取结果。**推荐使用此模式**。

#### 8.2.2 `delegate_output` 工具

获取委派的执行结果，用于异步模式下查询任务状态。

**参数**：`delegation_id`（必填）、`block`（是否阻塞等待）、`timeout`（阻塞超时秒数，默认 60）。

返回委派状态、任务摘要、高亮文件列表，或错误信息。

#### 8.2.3 `delegate_cancel` 工具

取消正在执行的委派。参数：`delegation_id`（取消指定委派）或 `all`（取消所有活跃委派）。

### 8.3 服务发现 (Service Discovery)

Delegator 需要知道可用的 Executor 及其能力。v1 支持通过 A2A Agent Card 进行服务发现：

- **Agent Card 获取**：尝试 `GET {baseUrl}/.well-known/agent-card.json`，备选 `GET {baseUrl}/.well-known/agent.json`
- **AWCP 扩展声明**：Executor 可在 Agent Card 中声明 AWCP 支持（`extensions` 字段）
- **MCP 工具层的 Peer Discovery**：启动时通过 `--peers` 参数指定 Executor 列表，自动获取各 Executor 的 Agent Card 并注入能力描述

## 9. 已知局限与未来方向 (Limitations & Future Roadmap)

v1 协议聚焦于"可用的最小闭环"，在设计上做了一些权衡和简化。以下列出已知局限及后续版本可能的演进方向：

### 9.1 当前局限

| 局限 | 说明 |
| :--- | :--- |
| **网络可达性** | SSHFS 传输要求 Executor 能直接访问 Delegator 的 SSH 端口。NAT、防火墙等网络边界会阻断连接。Archive 传输虽然更容易穿越边界，但需要完整传输工作空间，不适合大型项目。 |
| **细粒度权限** | 仅支持 `ro`（只读）和 `rw`（读写）两种访问模式，无法实现"允许修改但禁止删除"等细粒度控制。 |
| **并发冲突** | 多个委派同时访问同一目录时，协议本身不提供冲突检测或合并机制，依赖 Delegator 实施互斥策略。 |
| **身份互信** | Delegator 与 Executor 之间的信任关系依赖人工配置，没有去中心化的身份验证机制。 |
| **大文件传输** | Archive 传输将整个工作空间编码为 Base64，对于大型工作空间会消耗大量内存和带宽。 |
| **增量同步** | 两种传输方式都不支持增量同步。SSHFS 是实时的但按需读取，Archive 是完整复制。没有类似 rsync 的差异同步能力。 |

### 9.2 v2 可能方向

| 方向 | 可能方案 |
| :--- | :--- |
| **Relay / Reverse Tunnel** | 引入中继服务器或反向隧道，解决 NAT 穿透问题。Delegator 可以主动连接到公网 Relay，Executor 通过 Relay 访问工作空间。 |
| **细粒度 ACL** | 基于 FUSE 或 OverlayFS 实现更细粒度的访问控制，如禁止删除、白名单路径等。 |
| **Git 协作模式** | 基于 Git Worktree 的分支合并策略，每个委派在独立分支上工作，完成后自动合并。支持真正的并行协作和冲突解决。 |
| **去中心化身份** | 引入 DID（Decentralized Identifier）和签名验证，实现无需中心化注册的身份互信。 |
| **流式传输** | 改进 Archive 传输，支持分块流式传输和增量更新，降低内存占用。 |
| **多 Executor 编排** | 支持将一个大任务拆分给多个 Executor 并行执行，结果自动合并。 |

### 9.3 扩展点

v1 的设计预留了以下扩展点，便于未来演进：

1. **Transport Adapter 可插拔**：新的传输方式只需实现 `TransportAdapter` 接口，无需修改核心协议。

2. **Auth 字段**：INVITE 消息包含可选的 `auth` 字段，为未来的认证机制预留空间。

3. **Requirements 字段**：INVITE 消息的 `requirements` 字段可以扩展，声明更多的执行环境要求。

4. **ExecutorConstraints**：Executor 可以声明更多约束，用于更精确的能力匹配。

---

## 附录 A：协议消息示例

### A.1 完整协议流程示例（Archive 传输）

**1. INVITE**
```json
{
  "version": "1",
  "type": "INVITE",
  "delegationId": "dlg_a1b2c3d4",
  "task": {
    "description": "Add unit tests for utils module",
    "prompt": "Please add comprehensive unit tests for all functions in src/utils.ts..."
  },
  "lease": {
    "ttlSeconds": 3600,
    "accessMode": "rw"
  },
  "environment": {
    "resources": [
      { "name": "workspace", "type": "fs", "source": "/home/user/my-project", "mode": "rw" }
    ]
  },
  "requirements": {
    "transport": "archive"
  }
}
```

**2. ACCEPT**
```json
{
  "version": "1",
  "type": "ACCEPT",
  "delegationId": "dlg_a1b2c3d4",
  "executorWorkDir": {
    "path": "/awcp/workspaces/dlg_a1b2c3d4"
  },
  "executorConstraints": {
    "acceptedAccessMode": "rw",
    "maxTtlSeconds": 3600,
    "sandboxProfile": {
      "cwdOnly": true,
      "allowNetwork": true,
      "allowExec": true
    }
  }
}
```

**3. START**
```json
{
  "version": "1",
  "type": "START",
  "delegationId": "dlg_a1b2c3d4",
  "lease": {
    "expiresAt": "2026-02-01T13:00:00.000Z",
    "accessMode": "rw"
  },
  "workDir": {
    "transport": "archive",
    "workspaceBase64": "UEsDBBQAAAAIAM1Y...",
    "checksum": "a1b2c3d4e5f6..."
  }
}
```

**4. START 响应**
```json
{ "ok": true }
```

**5. SSE 事件流**
```
data: {"delegationId":"dlg_a1b2c3d4","type":"status","timestamp":"2026-02-01T12:00:01.000Z","status":"running"}

data: {"delegationId":"dlg_a1b2c3d4","type":"done","timestamp":"2026-02-01T12:05:30.000Z","summary":"Added 15 unit tests for utils module. All tests passing.","highlights":["src/utils.test.ts"],"resultBase64":"UEsDBBQAAAAIAM1Y..."}
```

### A.2 错误响应示例

**Executor 拒绝（达到并发上限）**
```json
{
  "version": "1",
  "type": "ERROR",
  "delegationId": "dlg_a1b2c3d4",
  "code": "DECLINED",
  "message": "Maximum concurrent delegations reached",
  "hint": "Try again later when current tasks complete"
}
```

**工作空间过大**
```json
{
  "version": "1",
  "type": "ERROR",
  "delegationId": "dlg_a1b2c3d4",
  "code": "WORKSPACE_TOO_LARGE",
  "message": "Workspace exceeds size limits: 250MB > 100MB",
  "hint": "Consider selecting a smaller subdirectory or excluding large files"
}
```

### A.3 SSHFS 传输 START 消息示例

```json
{
  "version": "1",
  "type": "START",
  "delegationId": "dlg_e5f6g7h8",
  "lease": {
    "expiresAt": "2026-02-01T13:00:00.000Z",
    "accessMode": "rw"
  },
  "workDir": {
    "transport": "sshfs",
    "endpoint": {
      "host": "192.168.1.100",
      "port": 22,
      "user": "awcp"
    },
    "exportLocator": "/home/awcp/.awcp/envs/dlg_e5f6g7h8/workspace",
    "credential": {
      "privateKey": "-----BEGIN OPENSSH PRIVATE KEY-----\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmU...",
      "certificate": "-----BEGIN SSH CERTIFICATE-----\nAAAAHHNzaC1lZDI1NTE5LWNlcnQtdjF..."
    },
    "options": {
      "StrictHostKeyChecking": "no"
    }
  }
}
```

### A.4 Storage 传输 START 消息示例

```json
{
  "version": "1",
  "type": "START",
  "delegationId": "dlg_i9j0k1l2",
  "lease": {
    "expiresAt": "2026-02-01T13:00:00.000Z",
    "accessMode": "rw"
  },
  "workDir": {
    "transport": "storage",
    "downloadUrl": "https://storage.example.com/awcp/dlg_i9j0k1l2/workspace.zip?token=abc123",
    "uploadUrl": "https://storage.example.com/awcp/dlg_i9j0k1l2/result.zip?token=xyz789",
    "checksum": "sha256:a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6...",
    "expiresAt": "2026-02-01T13:00:00.000Z",
    "headers": {
      "Authorization": "Bearer optional-auth-token"
    }
  }
}
```
